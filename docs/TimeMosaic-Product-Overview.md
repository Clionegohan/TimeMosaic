# TimeMosaic — プロダクト概要とプロトタイプ知見

本ドキュメントは、TimeMosaic を本番開発へ進めるための基礎資料です。アプリの目的、解決したい課題、提供機能、UI/レイアウト仕様、技術構成、API・データモデル、および今回のプロトタイプで得られた知見をまとめます。

---

## 概要（What/Why）

- TimeMosaic は「歴史的出来事（Event）」をタグで横断整理し、時系列で俯瞰・比較できる年表アプリです。
- 人が自分の興味・視点でタグを設計し、“その人だけの歴史地図”を作る体験を支援します。
- タグごとのレーンにイベントを並べ、重複期間のイベントは Google カレンダーのようにカラム分割で視認性を維持します。

---

## 解決する課題（User Problems）

- 時系列の断片的な知識が頭の中でつながらない
  - 人物・分野・地域が違っても、同時代に何が起きていたかを横断的に見たい。
- 自分の関心に合わせて歴史を切り取りたい
  - 固定カテゴリではなく、自由に付けたタグを組み合わせて比較したい。
- 年表は情報が重なると読めなくなる
  - 重なりを避けつつ、どのレーンのイベントか一目で分かる UI が欲しい。

---

## 提供機能（現状のプロトタイプ準拠）

- タイムライン表示（SVG）
  - タグごとのレーンを横並びに表示。
  - レーン内のイベントは「期間が重なるものをグルーピング → 最小列数へ自動分配（衝突回避）」で配置。
  - 点イベント（End なし）は最小高さを確保し、読める大きさを担保。
- フィルタリング
  - タグ選択、開始年の From/To で絞り込み。
- イベント作成
  - タイトル、説明、開始年、任意の終了年、複数タグを指定して作成。
- ツールチップ/詳細
  - イベントにホバーするとタイトル/年/説明/タグのツールチップを表示。
  - クリックでモーダルの詳細表示。
- ズーム/ビュー切替
  - スライダーでズーム、Fit-to-Screen。
  - タイムライン/リスト表示の切替。

---

## 主要 UI/レイアウト仕様（プロトタイプの実装に基づく）

- レーン（Lane）
  - 基本単位はタグ。タグ未設定は「Untagged」レーンに出す。
  - レーンごとに淡色チント＋境界線で視覚的に区切る。
- イベント配置（Collision-Avoidance）
  - 縦軸が時間、横方向にカラム分割。
  - 期間が重なるイベント群をクラスタ化し、貪欲法で最小列数に割り当て。
  - 列幅はクラスタ内で均等割り、列間に余白。
- イベントボックス
  - 角丸矩形、レーン色を薄く塗り、枠線で強調。
  - タイトル/年号を内部に表示し、`clipPath` でボックス外にはみ出さないようクリップ。
  - 点イベントは最小高さ（現状 36px）を保証。
- 軸/目盛
  - 縦軸に年代。1/2/5 系の nice tick を採用。
- ツールチップ
  - ホバーで HTML ツールチップを表示。スクロール・ズームに追従。

---

## 技術構成（このリポジトリ時点）

- Web（プロトタイプ）: `mvp/web`
  - 素の JS + SVG。`index.html`, `styles.css`, `app.js`。
  - タイムライン描画、レーン/カラムレイアウト、ツールチップを実装。
- API（プロトタイプ）: `mvp/server`
  - Node.js（Express）。メモリ内データで `/events`, `/tags` を提供。
  - 静的配信で `mvp/web` をホスト。
- 既存の他ドキュメント
  - `docs/mvp-spec.md`: MVP の目的・データモデル案（Prisma）
  - `docs/Time_Stack.md`: 本番の技術スタック基準（Next.js / NestJS / Prisma / Neon / Clerk）

---

## 本番技術構成（Time_Stack.md 準拠）

- フロント: Next.js（React, App Router） on Vercel
- 認証: Clerk（ホスト型, Email/Google 等）
- API: NestJS（TypeScript） on Render
- ORM: Prisma
- DB: Postgres（Neon）
- 通信: Next.js → NestJS を REST で接続（Clerk の JWT を付与）

---

## API 概要（プロトタイプ実装）

- `GET /tags`
  - 全タグ一覧を返す。
- `POST /tags { name }`
  - タグ作成。重複時は 409。
- `GET /events?tagIds=...&startYearFrom=...&startYearTo=...`
  - タグ/開始年レンジでフィルタし、開始年昇順で返す。
- `GET /events/:id`
  - 単一イベント取得。
- `POST /events { title, description?, startYear, endYear?, tagIds[] }`
  - イベント作成。タグ存在チェックあり。
- `PUT /events/:id { ... }`
  - イベント更新。
- `DELETE /events/:id`
  - イベント削除。

---

## データモデル（将来の本番想定：Prisma 案の要約）

- Event
  - `id`, `title`, `description?`, `startYear`, `endYear?`, `createdAt`, `updatedAt`
- Tag
  - `id`, `name(UNIQUE)`, `createdAt`, `updatedAt`
- Event–Tag
  - M:N。暗黙 M:N で可。属性が必要なら明示中間。
- 推奨インデックス
  - Event: `startYear`, `(startYear, endYear)`
  - 中間: `eventId`, `tagId`

---

## プロトタイプから得られた知見（要点）

- モデルは「Event + Tag」に絞るのがシンプルで有効（カテゴリは不要）。
- 読みやすさは“衝突回避 + 最小高さ + 太字/年号 + レーン配色”で大きく改善。
- SVG 採用により、ズーム/ラベル描画/スタイル調整が柔軟。
- フィルタをサーバ側で先に当てるだけで描画負荷が大幅軽減。
- ツールチップはネイティブ `title` より HTML の方が情報量と表現力で優位。

---

## 本番開発の指針（Recommendations）

- 認証/マルチユーザー
  - Clerk を採用。Next.js でセッション取得 → API 呼出時に Bearer JWT 付与。
  - DB 上の User は Clerk の `userId` を外部キーとして保持し、イベントを userId に紐づける。
- 永続化/DB
  - Prisma + PostgreSQL（Neon）。タグ名は一意制約。削除時は中間を CASCADE。
- バリデーション
  - DTO で Start 必須、End は null 許容。`endYear >= startYear` チェック。タグ存在検証。
- パフォーマンス
  - ページネーション、年レンジに応じた逐次ロード、ズームレベルに応じた縮約表現を検討。
- アクセシビリティ
  - キーボード操作（フォーカス時ツールチップ/詳細表示）、コントラスト比の確保。
- UX 拡張
  - ドラッグパン/ホイールズーム、イベントのインライン編集、PNG/SVG エクスポート、共有リンク（状態をクエリ化）。
- テスト/品質
  - レイアウト（カラム割当）、tick 計算などに単体テスト。E2E で主要フロー（フィルタ/作成/表示）。

---

## ロードマップ（例）

1. ユーザー/認証 + 永続化（Prisma/DB）導入
2. イベント編集/削除/複製、タグ管理 UI
3. パン/ホイールズーム、縮約表示（密集時）
4. 共有/エクスポート、検索（全文/タグ）
5. BCE 対応・別カレンダ対応の検討

---

## 参考：このプロトタイプの特徴的な実装

- タグごとのレーン分割 + 重複期間のカラム割当（Google カレンダー風）。
- `clipPath` によるテキストのはみ出し防止。
- HTML ツールチップで詳細表示（スクロール/ズームに追従）。
- ズームスライダー + Fit-to-Screen。

---

以上。TimeMosaic の本番開発に着手する際は、本ドキュメントと `docs/mvp-spec.md`・`docs/prototype-insights.md` を併読し、データモデル/UX/非機能要件を段階的に具体化してください。
