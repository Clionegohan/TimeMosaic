# Markdownパーサー仕様書

## 1. 目的

TimeMosaicアプリケーションにおいて、ユーザーが作成したMarkdown形式の歴史イベントファイルをパースし、TypeScriptの型定義されたデータ構造に変換する機能を提供する。

## 2. スコープ

### 含まれる機能
- Markdownファイルの読み込みと解析
- イベントデータの抽出（日付、タイトル、タグ、説明文）
- 型安全なデータ構造への変換
- 基本的なバリデーションとエラーハンドリング

### 含まれない機能
- Markdownファイルの書き込み・編集
- 複数ファイルの同時処理
- 高度なMarkdown記法のレンダリング

## 3. データモデル（TypeScript型定義）

### 3.1 基本型定義

```typescript
/**
 * 部分的な日付情報
 * 年のみ、年月、または年月日のいずれかの形式を表現
 */
interface PartialDate {
  year: number;
  month?: number;  // 1-12
  day?: number;    // 1-31
}

/**
 * イベントデータ
 */
interface Event {
  id: string;              // 一意識別子（UUID v4推奨）
  date: PartialDate;       // イベント日付
  title: string;           // イベントタイトル
  tags: string[];          // タグ配列（最低1つ）
  description?: string;    // 説明文（オプション）
  raw: string;             // 元のMarkdownテキスト
}

/**
 * パース結果
 */
interface ParseResult {
  events: Event[];         // 正常にパースされたイベント
  errors: ParseError[];    // パースエラーの詳細
}

/**
 * パースエラー情報
 */
interface ParseError {
  line?: number;           // エラーが発生した行番号
  message: string;         // エラーメッセージ
  raw?: string;            // エラーが発生した元テキスト
}
```

## 4. 入力・出力仕様

### 4.1 入力

**形式**: Markdown形式のテキストファイル（UTF-8エンコーディング）

**構造**:
```markdown
## [年] [イベント名]
#タグ1 #タグ2 ...

[説明文（任意・複数行可）]

---
```

**日付フォーマット**:
- `YYYY` 例: `1945`
- `YYYY-MM` 例: `1945-08`
- `YYYY-MM-DD` 例: `1945-08-15`

### 4.2 出力

`ParseResult`型のオブジェクト（上記3.1参照）

## 5. 処理フロー

### 5.1 全体フロー

```
入力: Markdownテキスト
  ↓
1. テキストを行配列に分割
  ↓
2. 見出し行（## で始まる）を検出してセクション分割
  ↓
3. 各セクションを処理:
   - 日付とタイトルを抽出
   - タグ行を抽出
   - 説明文を抽出
   - Eventオブジェクトを生成
  ↓
4. バリデーション実行
  ↓
5. ParseResultを返却
```

### 5.2 詳細処理

#### 5.2.1 見出し行のパース

**入力**: `## 1945-08-15 終戦記念日`

**処理**:
1. 行が `##` で始まることを確認
2. `##` 以降の部分をトリム
3. 最初の空白までを日付として抽出
4. 残りをタイトルとして抽出

**出力**: `{ date: "1945-08-15", title: "終戦記念日" }`

#### 5.2.2 日付のパース

**入力**: `"1945-08-15"`, `"1945-08"`, `"1945"`

**処理**:
1. ハイフン `-` で分割
2. パート数に応じて year, month, day を割り当て
3. 数値に変換して妥当性を検証

**出力**: `PartialDate`オブジェクト

**バリデーション**:
- year: 1以上の整数
- month: 1-12の範囲
- day: 1-31の範囲（月ごとの日数は簡易チェック）

#### 5.2.3 タグ行のパース

**入力**: `#歴史 #日本 #第二次世界大戦`

**処理**:
1. 行が `#` で始まることを確認（空白除く）
2. 空白で分割
3. 各要素から `#` を除去
4. 配列として保存

**出力**: `["歴史", "日本", "第二次世界大戦"]`

**バリデーション**:
- 最低1つのタグが必須
- 空のタグは除外

#### 5.2.4 説明文のパース

**入力**: タグ行以降、次の見出しまたは `---` までの全テキスト

**処理**:
1. 対象行を結合
2. 前後の空白をトリム
3. `---` 行は除外
4. 空の場合は `undefined`

**出力**: `string | undefined`

## 6. エラーハンドリング

### 6.1 エラーの種類と対応

| エラー種別 | 対応 | エラーメッセージ例 |
|-----------|------|------------------|
| 見出しなし | スキップ、警告 | `No heading found in section` |
| 日付パース失敗 | スキップ、エラー | `Invalid date format: {date}` |
| タグなし | スキップ、警告 | `No tags found for event: {title}` |
| 不正な年 | スキップ、エラー | `Invalid year: {year}` |
| 不正な月 | スキップ、エラー | `Invalid month: {month} (must be 1-12)` |
| 不正な日 | スキップ、エラー | `Invalid day: {day} (must be 1-31)` |

### 6.2 エラー時の動作

- パースエラーが発生したイベントは `events` 配列に含めない
- エラー情報は `errors` 配列に追加
- パース処理は継続（1つのエラーで全体を停止しない）
- 最終的に `events` が空配列でも正常終了（警告出力）

## 7. 受け入れ基準（Acceptance Criteria）

### AC1: 基本的なイベントのパース
- Given: 正しい形式の単一イベントMarkdown
- When: パーサーを実行
- Then: 1つのEventオブジェクトが返され、エラーが0件

### AC2: 複数イベントのパース
- Given: 3つのイベントを含むMarkdown
- When: パーサーを実行
- Then: 3つのEventオブジェクトが返され、エラーが0件

### AC3: 年のみの日付
- Given: `## 1945 終戦記念日` の形式
- When: パーサーを実行
- Then: `PartialDate { year: 1945 }` が設定される

### AC4: 年月日の日付
- Given: `## 1945-08-15 終戦記念日` の形式
- When: パーサーを実行
- Then: `PartialDate { year: 1945, month: 8, day: 15 }` が設定される

### AC5: 複数タグの処理
- Given: `#歴史 #日本 #戦争` のタグ行
- When: パーサーを実行
- Then: `tags: ["歴史", "日本", "戦争"]` が設定される

### AC6: 説明文のパース
- Given: 複数行の説明文を含むイベント
- When: パーサーを実行
- Then: 改行を含む完全な説明文が `description` に設定される

### AC7: 説明文なしのイベント
- Given: 説明文のないイベント
- When: パーサーを実行
- Then: `description` が `undefined` になる

### AC8: 不正な日付のエラーハンドリング
- Given: `## abc 不正なイベント` の形式
- When: パーサーを実行
- Then: エラーが1件記録され、イベントは0件

### AC9: タグなしのエラーハンドリング
- Given: タグ行のないイベント
- When: パーサーを実行
- Then: 警告が記録され、イベントはスキップされる

### AC10: ID生成
- Given: 任意のイベント
- When: パーサーを実行
- Then: 各イベントに一意のIDが付与される

## 8. テストケース

### テストケース1: 完全なイベント

**入力**:
```markdown
## 1945-08-15 終戦記念日
#歴史 #日本 #第二次世界大戦

第二次世界大戦の終結を告げる玉音放送が流れた日。
日本は連合国に対して無条件降伏を受け入れた。
```

**期待される出力**:
```typescript
{
  events: [
    {
      id: "[UUID]",
      date: { year: 1945, month: 8, day: 15 },
      title: "終戦記念日",
      tags: ["歴史", "日本", "第二次世界大戦"],
      description: "第二次世界大戦の終結を告げる玉音放送が流れた日。\n日本は連合国に対して無条件降伏を受け入れた。",
      raw: "[元のテキスト]"
    }
  ],
  errors: []
}
```

### テストケース2: 年のみの日付

**入力**:
```markdown
## 1969 アポロ11号月面着陸
#科学 #宇宙
```

**期待される出力**:
```typescript
{
  events: [
    {
      id: "[UUID]",
      date: { year: 1969 },
      title: "アポロ11号月面着陸",
      tags: ["科学", "宇宙"],
      description: undefined,
      raw: "[元のテキスト]"
    }
  ],
  errors: []
}
```

### テストケース3: 複数イベント

**入力**:
```markdown
## 1945 終戦記念日
#歴史 #日本

終戦。

---

## 1969 アポロ11号
#科学

月面着陸。
```

**期待される出力**:
```typescript
{
  events: [
    {
      id: "[UUID-1]",
      date: { year: 1945 },
      title: "終戦記念日",
      tags: ["歴史", "日本"],
      description: "終戦。",
      raw: "[元のテキスト]"
    },
    {
      id: "[UUID-2]",
      date: { year: 1969 },
      title: "アポロ11号",
      tags: ["科学"],
      description: "月面着陸。",
      raw: "[元のテキスト]"
    }
  ],
  errors: []
}
```

### テストケース4: 不正な日付

**入力**:
```markdown
## abc 不正なイベント
#テスト
```

**期待される出力**:
```typescript
{
  events: [],
  errors: [
    {
      message: "Invalid date format: abc",
      raw: "## abc 不正なイベント\n#テスト"
    }
  ]
}
```

### テストケース5: タグなし

**入力**:
```markdown
## 1945 タグなしイベント

説明文。
```

**期待される出力**:
```typescript
{
  events: [],
  errors: [
    {
      message: "No tags found for event: タグなしイベント",
      raw: "[元のテキスト]"
    }
  ]
}
```

### テストケース6: 空のMarkdown

**入力**:
```markdown

```

**期待される出力**:
```typescript
{
  events: [],
  errors: []
}
```

### テストケース7: 見出しのみ（タグなし）

**入力**:
```markdown
## 2024 イベント

説明文があるがタグがない。
```

**期待される出力**:
```typescript
{
  events: [],
  errors: [
    {
      message: "No tags found for event: イベント",
      raw: "[元のテキスト]"
    }
  ]
}
```

### テストケース8: 不正な月

**入力**:
```markdown
## 1945-13-01 不正な月
#テスト
```

**期待される出力**:
```typescript
{
  events: [],
  errors: [
    {
      message: "Invalid month: 13 (must be 1-12)",
      raw: "[元のテキスト]"
    }
  ]
}
```

### テストケース9: 区切り文字の処理

**入力**:
```markdown
## 1945 イベント1
#タグ1

説明1

---

## 1946 イベント2
#タグ2

説明2
```

**期待される出力**:
```typescript
{
  events: [
    {
      id: "[UUID-1]",
      date: { year: 1945 },
      title: "イベント1",
      tags: ["タグ1"],
      description: "説明1",
      raw: "[元のテキスト]"
    },
    {
      id: "[UUID-2]",
      date: { year: 1946 },
      title: "イベント2",
      tags: ["タグ2"],
      description: "説明2",
      raw: "[元のテキスト]"
    }
  ],
  errors: []
}
```

## 9. 実装の制約事項

### 9.1 技術制約
- TypeScriptで実装
- 外部Markdownパーサーライブラリは使用しない（独自実装）
- UUID生成には標準的なライブラリ（`uuid`パッケージなど）を使用可能

### 9.2 パフォーマンス制約
- 1000イベントを1秒以内に処理できること
- メモリ使用量は入力ファイルサイズの10倍以内

### 9.3 コード品質
- 関数は単一責任の原則に従う
- ユニットテストでカバレッジ80%以上を目指す
- ESLintのルールに準拠

## 10. 実装ファイル構成（案）

```
src/
  ├── lib/
  │   └── parser/
  │       ├── index.ts              # パーサーのエントリーポイント
  │       ├── types.ts              # 型定義
  │       ├── parseEvent.ts         # イベントパース処理
  │       ├── parseDate.ts          # 日付パース処理
  │       ├── parseTags.ts          # タグパース処理
  │       ├── parseDescription.ts   # 説明文パース処理
  │       └── validators.ts         # バリデーション処理
  └── __tests__/
      └── parser/
          ├── parseEvent.test.ts
          ├── parseDate.test.ts
          └── integration.test.ts
```

## 11. 次のステップ

1. 型定義ファイル（`types.ts`）の作成
2. 日付パーサー（`parseDate.ts`）の実装とテスト
3. タグパーサー（`parseTags.ts`）の実装とテスト
4. イベントパーサー（`parseEvent.ts`）の実装とテスト
5. メインパーサー（`index.ts`）の実装と統合テスト
6. エラーハンドリングの改善
7. パフォーマンステストと最適化
