name: Spec Guard

on:
  pull_request:
    types: [opened, edited, synchronize, labeled, unlabeled]

jobs:
  spec-guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Bypass with label 'spec-exempt'
        id: exempt
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            core.setOutput('exempt', labels.includes('spec-exempt'))

      - name: Extract Spec ID from title/body
        if: steps.exempt.outputs.exempt != 'true'
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const text = `${pr.title}\n\n${pr.body || ''}`;
            const m = text.match(/SPEC-\d{4}-\d{2}-\d{2}-[A-Za-z0-9-]+/);
            if (!m) core.setFailed('Spec ID が PR タイトルまたは本文に見つかりません。');
            else core.setOutput('specId', m[0]);

      - name: Verify Spec file exists and Accepted
        if: steps.exempt.outputs.exempt != 'true'
        run: |
          SPEC_ID="${{ steps.extract.outputs.specId }}"
          echo "Checking for $SPEC_ID"
          FILE=$(git ls-files "docs/specs/**/${SPEC_ID}*.md" | head -n1 || true)
          if [ -z "$FILE" ]; then
            echo "Specファイルが見つかりません: $SPEC_ID" >&2
            exit 1
          fi
          if ! grep -q "Status:\s*Accepted" "$FILE"; then
            echo "SpecのStatusがAcceptedではありません（$FILE）。" >&2
            exit 1
          fi
          echo "Spec OK: $FILE"

